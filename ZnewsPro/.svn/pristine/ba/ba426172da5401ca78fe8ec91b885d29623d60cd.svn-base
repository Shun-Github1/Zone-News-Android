package com.anssy.znewspro.ui.mainfrag.homechild

import android.annotation.SuppressLint
import android.os.Bundle
import android.util.Log
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.ImageView
import android.widget.TextView
import androidx.activity.viewModels
import androidx.constraintlayout.widget.ConstraintLayout
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.anssy.videolive.utils.Constants
import com.anssy.znewspro.R
import com.anssy.znewspro.base.BaseFragment
import com.anssy.znewspro.databinding.FragChildHomeBinding
import com.anssy.znewspro.entry.HomeBannerEntry
import com.anssy.znewspro.entry.HomeNewsEntry
import com.anssy.znewspro.model.HomeModel
import com.anssy.znewspro.selfview.NewNestedScrollView
import com.anssy.znewspro.ui.MainActivity
import com.anssy.znewspro.utils.Utils
import com.bumptech.glide.Glide
import com.zhpan.bannerview.BaseBannerAdapter
import com.zhpan.bannerview.BaseViewHolder
import com.zhy.adapter.recyclerview.CommonAdapter
import com.zhy.adapter.recyclerview.base.ViewHolder
import java.text.SimpleDateFormat
import java.util.Locale
import kotlin.math.abs


/**
 * @Description Today/HongKong/China
 * @Author yulu
 * @CreateTime 2025年06月30日 11:22:01
 */

class HomeChildFrag : BaseFragment() {
    private lateinit var mViewBinding: FragChildHomeBinding

    companion object {
        private const val TYPE_NEWS = "type"
        fun getInstance(tag: String): HomeChildFrag {
            val bundle = Bundle()
            bundle.putString(TYPE_NEWS, tag)
            val childFrag = HomeChildFrag()
            childFrag.arguments = bundle
            return childFrag
        }
    }

    private lateinit var mAdapter: CommonAdapter<HomeNewsEntry>
    private var mNewsList = ArrayList<HomeNewsEntry>()
    private var mBannerList = ArrayList<HomeBannerEntry>()
    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View {
        mViewBinding = FragChildHomeBinding.inflate(inflater)
        return mViewBinding.root
    }

    override fun onStart() {
        super.onStart()
        mViewBinding.homeBanner.startLoop()
    }

    private lateinit var mBannerAdapter: HomeAdapter
    private var mProgressWidth = 0
    override fun initData() {
        val string = arguments?.getString(TYPE_NEWS)
        Log.e("xxx", "type:" + string)
        mProgressWidth = resources.displayMetrics.widthPixels - Utils.dpToPx(36f, resources)
        initView()
        initBannerData()
        initHomeData()
    }

    private fun initView() {
        mBannerAdapter = HomeAdapter()
        mViewBinding.homeBanner.setAdapter(mBannerAdapter)
        mViewBinding.homeBanner.create()
        mViewBinding.homeRecycler.layoutManager =
            object : LinearLayoutManager(mContext, RecyclerView.VERTICAL, false) {
                override fun canScrollVertically(): Boolean {
                    return false
                }
            }
        val dateFormat = SimpleDateFormat("yyyy-MM-dd HH:mm:ss", Locale.getDefault())
        mAdapter = object :
            CommonAdapter<HomeNewsEntry>(mContext, R.layout.item_home_recycler, mNewsList) {
            @SuppressLint("SetTextI18n")
            override fun convert(holder: ViewHolder?, t: HomeNewsEntry?, position: Int) {
                val placeTv: TextView = holder!!.getView(R.id.place_tv)
                val tagTv: TextView = holder.getView(R.id.tag_tv)
                val titleTv: TextView = holder.getView(R.id.news_title_tv)
                val newsIv: ImageView = holder.getView(R.id.news_iv)
                val scoreTv: TextView = holder.getView(R.id.score_tv)
                val scoreDivideView: View = holder.getView(R.id.score_divider_tv)
                val timeTv: TextView = holder.getView(R.id.news_time_tv)
                val transScoreTv: TextView = holder.getView(R.id.trans_score_tv)
                placeTv.text = t!!.place
                transScoreTv.text = "情感分析：" + t.score
                tagTv.text = t.tag
                scoreTv.text = t.score.toString()
                titleTv.text = t.title
                Glide.with(mContext).load(t.imageUrl).into(newsIv)
                try {
                    val parse = dateFormat.parse(t.time)
                    timeTv.text = Utils.getSpaceTime(parse!!.time)
                } catch (e: Exception) {
                    e.printStackTrace()
                }
                scoreTv.post(Runnable {
                    val params = scoreTv.layoutParams as ConstraintLayout.LayoutParams
                    params.marginStart = changeScoreToMargin(
                        t.score,
                        mProgressWidth
                    ).toInt() - scoreTv.measuredWidth / 2
                    scoreTv.layoutParams = params
                })

                val params1 = scoreDivideView.layoutParams as ConstraintLayout.LayoutParams
                params1.marginStart =
                    changeScoreToMargin(t.score, mProgressWidth).toInt() - Utils.dpToPx(
                        1.5f,
                        resources
                    )
                scoreDivideView.layoutParams = params1
            }
        }
        mViewBinding.homeRecycler.adapter = mAdapter
        mViewBinding.scrollView.addScrollChangeListener(object :
            NewNestedScrollView.AddScrollChangeListener {
            override fun onScrollChange(
                scrollX: Int,
                scrollY: Int,
                oldScrollX: Int,
                oldScrollY: Int
            ) {

            }

            override fun onScrollState(state: NewNestedScrollView.ScrollState?) {
                when (state) {
                    NewNestedScrollView.ScrollState.SCROLLING, NewNestedScrollView.ScrollState.DRAG -> {
                        (requireActivity() as MainActivity).mBottomView?.visibility = View.INVISIBLE
                    }

                    NewNestedScrollView.ScrollState.IDLE -> {
                        (requireActivity() as MainActivity).mBottomView?.visibility = View.VISIBLE
                    }

                    else -> {}
                }
            }

        })
    }


    @SuppressLint("NotifyDataSetChanged")
    private fun initHomeData() {
        mNewsList.run {
            add(
                HomeNewsEntry(
                    "https://www.laiketui.com/wp-content/uploads/2023/11/8826f202310071447543819.jpg",
                    -0.33,
                    "香港",
                    "经济",
                    "2025-07-01 10:24:24",
                    "小米汽車業務預計今年三四季度實現盈利小米汽車業務預計今年三四季度實現盈利"
                )
            )
            add(
                HomeNewsEntry(
                    "https://www.laiketui.com/wp-content/uploads/2023/11/8826f202310071447543819.jpg",
                    0.00,
                    "香港",
                    "经济",
                    "2025-07-01 10:24:24",
                    "小米汽車業務預計今年三四季度實現盈利小米汽車業務預計今年三四季度實現盈利"
                )
            )
            add(
                HomeNewsEntry(
                    "https://www.laiketui.com/wp-content/uploads/2023/11/8826f202310071447543819.jpg",
                    0.33,
                    "香港",
                    "经济",
                    "2025-07-01 10:24:24",
                    "小米汽車業務預計今年三四季度實現盈利小米汽車業務預計今年三四季度實現盈利"
                )
            )
            add(
                HomeNewsEntry(
                    "https://www.laiketui.com/wp-content/uploads/2023/11/8826f202310071447543819.jpg",
                    0.78,
                    "香港",
                    "经济",
                    "2025-07-01 10:24:24",
                    "小米汽車業務預計今年三四季度實現盈利小米汽車業務預計今年三四季度實現盈利"
                )
            )
        }
        mAdapter.notifyDataSetChanged()
    }


    private fun initBannerData() {
        mBannerList.run {
            add(
                HomeBannerEntry(
                    "https://www.laiketui.com/wp-content/uploads/2023/11/8826f202310071447543819.jpg",
                    "聯合反詐！港警攜手六地拘逾千人成功攔截1.5億騙款",
                    "香港新聞網6月5日電　曾撰文預測“香港已玩完”的美國國際金融服務公司摩根士丹利亞洲區前主席斯蒂芬·羅奇日前改口稱，在中美角力下，香港特區反而從中得益，並正重新…"
                )
            )
            add(
                HomeBannerEntry(
                    "https://www.laiketui.com/wp-content/uploads/2023/11/8826f202310071447543819.jpg",
                    "聯合反詐！港警攜手六地拘逾千人成功攔截1.5億騙款",
                    "香港新聞網6月5日電　曾撰文預測“香港已玩完”的美國國際金融服務公司摩根士丹利亞洲區前主席斯蒂芬·羅奇日前改口稱，在中美角力下，香港特區反而從中得益，並正重新…"
                )
            )
            add(
                HomeBannerEntry(
                    "https://www.laiketui.com/wp-content/uploads/2023/11/8826f202310071447543819.jpg",
                    "聯合反詐！港警攜手六地拘逾千人成功攔截1.5億騙款",
                    "香港新聞網6月5日電　曾撰文預測“香港已玩完”的美國國際金融服務公司摩根士丹利亞洲區前主席斯蒂芬·羅奇日前改口稱，在中美角力下，香港特區反而從中得益，並正重新…"
                )
            )
        }
        mViewBinding.homeBanner.refreshData(mBannerList)
    }

    override fun onStop() {
        super.onStop()
        mViewBinding.homeBanner.stopLoop()
    }


    inner class NetViewHolder(itemView: View) :
        BaseViewHolder<HomeBannerEntry>(itemView) {
        private val mBannerIv: ImageView = itemView.findViewById(R.id.banner_image)
        private val mTitleTv: TextView = itemView.findViewById(R.id.banner_title_tv)
        private val mTransTv: TextView = itemView.findViewById(R.id.banner_desc_tv)
        override fun bindData(
            data: HomeBannerEntry,
            position: Int,
            pageSize: Int
        ) {
            Glide.with(mContext!!).load(data.bannerUrl)
                .centerCrop().into(mBannerIv)
            mTitleTv.text = data.title
            mTransTv.text = data.desc
        }
    }

    /**
     * banner 适配器
     */
    inner class HomeAdapter :
        BaseBannerAdapter<HomeBannerEntry, NetViewHolder>() {
        override fun onBind(
            holder: NetViewHolder,
            data: HomeBannerEntry,
            position: Int,
            pageSize: Int
        ) {
            holder.bindData(data, position, pageSize)
        }

        override fun createViewHolder(itemView: View, viewType: Int): NetViewHolder {
            return NetViewHolder(itemView)
        }

        override fun getLayoutId(viewType: Int): Int {
            return R.layout.item_banner
        }
    }

}